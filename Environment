--[[
This module contains features focusing on enhancing the Football Fusion Environment.

Features:
* Automatic Team and Kicker Jerseys
* Field Goal Target Line
]]

local Services = {
    Storage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    Players = game:GetService("Players"),
    Tween = game:GetService("TweenService"),
    UserInput = game:GetService("UserInputService")
}

local module = {
    Settings = {
        AssetsFolder = "",
        AwayInfo = nil,
        HomeInfo = nil,
        IsDay = true
    }
}

local getcustomasset = getsynasset or getcustomasset
local FFValues = Services.Storage.Flags

-- ====== Jersey Functions ======
local function FindNumbers(children, inner, stroke)
    for i,v in ipairs(children) do
        if v:IsA("TextLabel") then
            v.TextColor3 = inner
            v.TextStrokeColor3 = stroke
        elseif #v:GetChildren() > 0 then
            FindNumbers(v:GetChildren(), inner, stroke)
        end
    end
end

local function SetJersey(player, teamInfo, pos)
    pcall(function()
        if not player.Character then return end
        task.spawn(function()
            local uniform = player.Character:WaitForChild("Uniform")
            wait(0.5)
            if not uniform:FindFirstChild("Helmet") then return end

            -- Helmet
            uniform.Helmet.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Helmet)
            uniform.Helmet.Mesh.TextureId = ""
            if uniform.Helmet:FindFirstChild("RightLogo") then
                uniform.Helmet.RightLogo.Decal.Texture = getcustomasset(module.Settings.AssetsFolder .. teamInfo.City .. " " .. teamInfo.Name .. "/Logo.png", false)
                uniform.Helmet.LeftLogo.Decal.Texture = getcustomasset(module.Settings.AssetsFolder .. teamInfo.City .. " " .. teamInfo.Name .. "/Logo.png", false)
            end

            -- Upper Uniform
            uniform.ShoulderPads.Front.Team.Text = string.upper(teamInfo.Name)
            uniform.ShoulderPads.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Jersey)
            uniform.Shirt.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Jersey)
            uniform.LeftShortSleeve.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Jersey)
            uniform.RightShortSleeve.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Jersey)

            -- Pants
            uniform.LeftPants.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Pants)
            uniform.RightPants.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Pants)

            -- Stripes
            uniform.LeftGlove.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)
            uniform.LeftShoe.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)
            uniform.LeftSock.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)
            uniform.RightGlove.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)
            uniform.RightShoe.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)
            uniform.RightSock.Color = Color3.fromHex(teamInfo.Colors.Jersey[pos].Stripe)

            -- Numbers
            FindNumbers(uniform:GetChildren(), Color3.fromHex(teamInfo.Colors.Jersey[pos].NumberInner), Color3.fromHex(teamInfo.Colors.Jersey[pos].NumberStroke))
        end)
    end)
end

-- ====== Main SetTeams Function ======
function module:SetTeams(awayInfo, homeInfo)
    module.Settings.AwayInfo = awayInfo
    module.Settings.HomeInfo = homeInfo

    -- Set Jerseys for all players
    for _, player in ipairs(Services.Players:GetPlayers()) do
        print("[ENVIRONMENT] Set " .. player.Name .. "'s Jersey")
        if player.Team.Name == FFValues.Home.Value.Name then
            SetJersey(player, module.Settings.HomeInfo, "Home")
        else
            SetJersey(player, module.Settings.AwayInfo, "Away")
        end
    end
end

-- ====== Remove Touchdown Song ======
function module:Touchdown(isHomeTeam)
    print("[ENVIRONMENT] Touchdown song disabled.")
end

-- ====== Day/Night Setter ======
function module:SetTime(isDay)
    module.Settings.IsDay = isDay
end

-- ====== Player Listeners ======
FFValues.Away.Changed:Connect(function(team)
    if team and team:IsA("Team") then
        team.PlayerAdded:Connect(function(player)
            if module.Settings.AwayInfo then
                print("[ENVIRONMENT] Set " .. player.Name .. "'s Jersey")
                SetJersey(player, module.Settings.AwayInfo, "Away")
            end
        end)
    end
end)

FFValues.Home.Changed:Connect(function(team)
    if team and team:IsA("Team") then
        team.PlayerAdded:Connect(function(player)
            if module.Settings.HomeInfo then
                print("[ENVIRONMENT] Set " .. player.Name .. "'s Jersey")
                SetJersey(player, module.Settings.HomeInfo, "Home")
            end
        end)
    end
end)

Services.Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        print("[ENVIRONMENT] Set " .. player.Name .. "'s Jersey")
        if player.Team.Name == FFValues.Home.Value.Name then
            SetJersey(player, module.Settings.HomeInfo, "Home")
        else
            SetJersey(player, module.Settings.AwayInfo, "Away")
        end
    end)
end)

-- ====== Field Goal Target Line ======
Services.UserInput.InputBegan:Connect(function(input)
    if input.KeyCode ~= Enum.KeyCode.F6 then return end

    local targetLine = Services.Workspace:FindFirstChild("TargetLine")
    if targetLine then
        print("[ENVIRONMENT] Disabled the Field Goal Target Line.")
        targetLine:Destroy()
        return
    end

    targetLine = Instance.new("Part")
    targetLine.Size = Vector3.new(160, 2.4, 1)
    targetLine.Transparency = 1
    targetLine.CanCollide = false
    targetLine.Anchored = true
    targetLine.CanTouch = false
    targetLine.Name = "TargetLine"

    local texture = Instance.new("Texture")
    texture.Texture = "rbxassetid://13183925348"
    texture.StudsPerTileU = 20
    texture.StudsPerTileV = 2.4
    texture.Parent = targetLine

    if Services.Workspace.LineDown.Position.Z > Services.Workspace.LineTogo.Position.Z then
        targetLine.Position = Vector3.new(0, 2.5, -37)
        targetLine.Orientation = Vector3.new(90, 180, 0)
    else
        targetLine.Position = Vector3.new(0, 2.5, 37)
        targetLine.Orientation = Vector3.new(90, 0, 0)
    end

    targetLine.Parent = Services.Workspace
    print("[ENVIRONMENT] Enabled the Field Goal Target Line.")
end)

return module
